name: CI pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'uat'
        type: choice
        options:
          - uat
          - prod

permissions:
  id-token: write
  contents: read 

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::084669006157:role/MyOIDCRole
          aws-region: ap-south-1 

      - name: Get commit message
        shell: bash
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:"%s" | sed 's/[^a-zA-Z0-9 ._:\/=+@-]//g')
          echo "COMMIT_MSG=$COMMIT_MSG" >> $GITHUB_ENV
          echo "Commit: $COMMIT_MSG"

      - name: Deploy to Dev S3
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: aws s3 cp release/ s3://dev-aditya-280595/ --recursive --exclude "*" --include "*.exe.txt" --exclude "win-unpacked/*"

      - name: Tag latest uploaded file
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        shell: bash
        run: |
          aws s3api put-object-tagging \
            --bucket dev-aditya-280595 \
            --key "$(aws s3api list-objects-v2 --bucket dev-aditya-280595 --query 'sort_by(Contents, &LastModified)[-1].Key' --output text)" \
            --tagging "{\"TagSet\":[{\"Key\":\"commit-message\",\"Value\":\"$COMMIT_MSG\"}]}"

      - name: Deploy to Prod S3
        if: startsWith(github.ref, 'refs/heads/release/')
        run: aws s3 cp index.html s3://prod-aditya-2805/index.html

      - name: Deploy to UAT S3
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'uat'
        run: aws s3 cp index.html s3://uat-aditya-2805/index.html

      - name: Deploy successful
        run: echo "Deployed Successfully."
